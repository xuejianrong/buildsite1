(function(win){
    // var SLICE_SIZE_512K = 524288,   //512K
    // SLICE_SIZE_1M = 1048576,    //1M
    // SLICE_SIZE_2M = 2097152,    //2M
    // LICE_SIZE_3M = 3145728,    //3M
    // MAX_UNSLICE_FILE_SIZE = 20971520;   //20M
    var Tools = {
        setUrlByFileInput: function(input, $img){
            if(!input || !$img || !$img[0] || !FileReader){
                return
            }
            var file = input['files'] && input['files'][0];
            if(file){
                var reader = new FileReader();
                reader.onload = function (e) {
                    $img.attr('src', e.target.result);
                };

                reader.readAsDataURL(file);
            }
        },

        /**
         * 提交文件(腾讯COS)
         * @param file  file输入框/file输入框对应文件(多选)
         * @param callback 回调方法,会接收参数{msg:消息, status:状态 , url:图片地址 , id:资源id };
         * @param progressCallback 进度回调方法,会接收参数 progress 1~100;
         * @param isPrivate 是否私有
         * @param keepName 是否保留文件名字
         */
        uploadFile: function(file, callback, progressCallback, isPrivate, keepName){
            var match, fileName, postfix;

            if(file){
                if(file.tagName == 'INPUT'){    //兼容input参数
                    file = file['files'][0];
                }
                match = file.name.split('.');
                fileName = match[0];
                postfix = match[1];
            }

            //参数错误
            if(!FormData || !file || !fileName || !postfix){
                return false
            }

            ajax({
                url: UeData['aUrl']['uploadInfoUrl'],   //由Framework所在php赋值
                data: {
                    isPrivate: isPrivate,
                    fileName: keepName ? fileName : null,
                    postfix: postfix
                },
                unblock: true,   //取消重复提交限制
                success: function(aData){
                    if(aData['status'] != 1){
                        callback(aData);
                        return
                    }
                    var aInfo = aData['data'],
                        fileSize = file.size;
                    if(fileSize < 20971520){
                        Tools.uploadFileHandle(aInfo['imgUrl'], file, callback, progressCallback, aInfo['sign'], aInfo['id']);
                    }else{
                        Tools.sliceUploadFileHandle(aInfo['imgUrl'], file, callback, progressCallback, aInfo['sign'], aInfo['id']);
                    }
                }
            });
        },

        /**
         * 提交文件
         * @param url 地址
         * @param file file输入框
         * @param callback 回调方法
         * @param progressCallback 进度回调方法
         * @param sign 签名(腾讯COS)
         * @param rid 资源id(腾讯COS)
         */
        uploadFileHandle: function(url, file, callback, progressCallback, sign, rid){
            if(!url || !file || !callback){
                return
            }

            var formData = new FormData(),
                xhr = new XMLHttpRequest();

            xhr.open("post", url, true);

            if(sign && rid){    //提交到腾讯云
                xhr.setRequestHeader('timeout', '60');
                xhr.setRequestHeader('Authorization', sign);
                formData.append('op', 'upload');
            }else{  //提交到自己服务器
                formData.append('_csrf', $('meta[name="csrf-token"]').attr('content'));
            }

            xhr.setRequestHeader("x-requested-with", "XMLHttpRequest");
            xhr.upload.addEventListener('progress', function(event) {
                if(event['lengthComputable'] && progressCallback && typeof(progressCallback)){
                    var progress = event['loaded'] / event['total'] * 100 | 0;
                    progressCallback(progress);
                }
            });
            xhr.addEventListener('load', function (res) {
                var info = JSON.parse(res['target']['response']);

                if(sign && rid){
                    Tools.uploadSuccessHandle(file, info, rid, callback, progressCallback);
                }else{
                    callback(info);
                }
            });

            formData.append('filecontent', file);

            xhr.send(formData);
        },
        /**
         * 分片提交文件
         * @param url 地址
         * @param file file输入框
         * @param callback 回调方法
         * @param progressCallback 进度回调方法
         * @param sign 签名(腾讯COS)
         * @param rid 资源id(腾讯COS)
         */
        sliceUploadFileHandle: function(url, file, callback, progressCallback, sign, rid){
            var slice = File.prototype.slice || File.prototype.mozSlice || File.prototype.webkitSlice,
                reader = new FileReader(),
                fileSize = file.size,
                formData, session, offset, sliceSize;

            //分片提交
            function sliceUploadFunc(){
                formData = new FormData();
                formData.append('op', 'upload_slice');
                formData.append('session', session);
                formData.append('offset', offset);
                formData.append('fileContent', slice.call(file, offset, offset + sliceSize));
                sendFormFunc(formData, function (res) {
                    var info = JSON.parse(res['target']['response']),
                        data = info['data'];
                    if(info['code'] == 0 && data.hasOwnProperty('offset')){
                        offset = data['offset'] += sliceSize;
                        sliceUploadFunc();
                    }else if(data && data['access_url']){
                        Tools.uploadSuccessHandle(file, info, rid, callback, progressCallback);
                    }
                });
            }

            //表单提交方法
            function sendFormFunc(formData, callback){
                var xhr = new XMLHttpRequest();
                xhr.open("post", url, true);
                xhr.setRequestHeader('timeout', '60');
                xhr.setRequestHeader('Authorization', sign);
                xhr.setRequestHeader("x-requested-with", "XMLHttpRequest");
                xhr.addEventListener('progress', function(event){
                    if(event['lengthComputable'] && progressCallback && typeof(progressCallback)){
                        var progress = (offset + event['loaded']) / fileSize * 100 | 0;
                        progressCallback(progress);
                    }
                });
                xhr.addEventListener('load', callback);
                xhr.send(formData);
            }

            //读取文件，获取sha1编码，请求分片信息
            reader.onload = function(event){
                formData = new FormData();
                formData.append('op', 'upload_slice');
                formData.append('sha', CryptoJS.SHA1(CryptoJS.lib.WordArray.create(event.target.result)).toString());
                formData.append('filesize', file.size);

                sendFormFunc(formData, function (res) {
                    var data, info = JSON.parse(res['target']['response']);
                    if(info['code'] == 0){
                        data = info['data'];
                        session = data['session'];
                        offset = data['offset'];
                        sliceSize = data['slice_size'];
                        if(data && data['access_url']){
                            Tools.uploadSuccessHandle(file, info, rid, callback, progressCallback);
                        }else{
                            sliceUploadFunc();
                        }
                    }else{
                        callback({
                            msg: info['message'],
                            status:  info['code'] == 0 ? 1 : 0
                        });
                    }
                });
            };
            reader.readAsArrayBuffer(file);
            progressCallback('文件上传准备中...');
        },

        /**
         * 上传成功方法
         * @param file
         * @param info
         * @param rid
         * @param callback
         * @param progressCallback
         */
        uploadSuccessHandle: function(file, info, rid, callback, progressCallback){
            var reader = new FileReader();
            reader.onload = function(event){
                callback({
                    msg: info['code'] == 0 ? '上传成功' : '上传失败',
                    status:  info['code'] == 0 ? 1 : 0,
                    url: event['target']['result'],
                    id: rid
                });
            };
            reader.readAsDataURL(file);

            if(progressCallback && typeof(progressCallback)){
                progressCallback('提交成功，正在生成预览...');
            }
        }
    };

    win.Tools = $.extend(win.Tools, Tools);
})(window);